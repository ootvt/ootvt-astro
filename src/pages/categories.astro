---
import { getCollection } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_TITLE } from '../consts';

const posts = await getCollection('blog');

// 统计每个标签的文章数量
const tagCounts = new Map<string, number>();
posts.forEach(post => {
	post.data.tags.forEach(tag => {
		tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
	});
});

// 转换为数组
const tags = Array.from(tagCounts.entries());

// 计算最大和最小文章数
const counts = tags.map(([_, count]) => count);
const maxCount = Math.max(...counts);
const minCount = Math.min(...counts);

// 辅助函数：生成随机样式数据
function getTagVisuals(count: number) {
	// 1. 字体大小
	const range = maxCount - minCount;
	const percent = range === 0 ? 0.5 : (count - minCount) / range;
	const fontSize = 1 + percent * 2; 

	// 2. [修改] 角度随机扩大到 (-45 ~ 45 度)
    // 之前是 60 (-30~30)，现在改为 91 (-45~45)
	const rot = Math.floor(Math.random() * 60) - 30;

    // 3. 位移随机 (X, Y)
    // 角度变大后，位移也可以稍微配合一下，保持混乱感
    const tx = Math.floor(Math.random() * 40) - 20;
    const ty = Math.floor(Math.random() * 40) - 20;

	// 4. 外边距随机
	const margin = `${Math.random() * 1 - 0.5}rem ${Math.random() * 2 - 1}rem`;

    // 5. 初始层级 (0-10)
    const zIndex = Math.floor(Math.random() * 10);

	return {
		fontSize: `${fontSize.toFixed(2)}rem`,
        rot,
        tx,
        ty,
		margin,
        zIndex
	};
}

// 随机打乱
const shuffledTags = tags.sort(() => Math.random() - 0.5);
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead title={`分类 - ${SITE_TITLE}`} description="博客文章分类" />
	<link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&family=Noto+Serif+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
		<style>
			/* 标签云容器 */
			.tag-cloud-container {
				display: flex;
				flex-wrap: wrap;
				justify-content: center;
				align-items: center;
				list-style: none;
				margin: 0;
                
                /* 保持较大的顶部内边距，防止45度旋转时棱角戳到导航栏 */
				padding: 10rem 2rem 5rem; 
                
                overflow: visible;
                position: relative;
                
                max-width: 800px;
                margin-left: auto;
                margin-right: auto;
			}

			.category-item {
                position: relative;
                transition: z-index 0s; 
			}

            /* 悬停时提升 父元素 li 的层级，防止被遮挡 */
            .category-item:hover {
                z-index: 9999 !important;
            }

			.category-link {
				display: inline-flex;
				align-items: center;
				gap: 0.3em;
				padding: 0.4em 0.8em;
				background-color: var(--box-bg);
				text-decoration: none;
				color: var(--main-color);
                border: 1px solid transparent;
                cursor: pointer;
                
                /* CSS 变量控制初始状态 */
                transform: translate(calc(var(--tx) * 1px), calc(var(--ty) * 1px)) rotate(calc(var(--rot) * 1deg));
                
				transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
                
                will-change: transform;
                backface-visibility: hidden;
			}

			.category-link:hover {
				border-color: var(--main-color);
				background-color: var(--bg-color); 
				
                /* 悬停归位：角度复原为 0度 或 5度，方便阅读 */
                /* 这里保持原来的设计：微转 5 度，放大 */
				transform: translate(0, 0) rotate(5deg) scale(1.2);
				
				box-shadow: 4px 4px 0px 0px var(--main-color);
			}

			.category-name {
				font-weight: 500;
                line-height: 1;
			}

			.category-count {
				font-size: 0.75em;
				font-weight: bold;
				opacity: 0.6;
                margin-left: 2px;
                vertical-align: top;
			}

			.total-info {
				margin-top: 5rem;
				text-align: center;
				color: var(--main-color);
				font-size: 0.75rem; 
				opacity: 0.6;
			}

			@media (max-width: 768px) {
                .tag-cloud-container {
                    padding: 6rem 1rem;
                }
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<ul class="tag-cloud-container">
				{shuffledTags.map(([tag, count]) => {
                    const visuals = getTagVisuals(count);
                    return (
					<li 
                        class="category-item" 
                        style={`
                            margin: ${visuals.margin}; 
                            z-index: ${visuals.zIndex};
                        `}
                    >
						<a 
                            href={`/tags/${tag}/`} 
                            class="category-link"
                            style={`
                                font-size: ${visuals.fontSize}; 
                                --tx: ${visuals.tx};
                                --ty: ${visuals.ty};
                                --rot: ${visuals.rot};
                            `}
                        >
							<span class="category-name"># {tag}</span>
							<span class="category-count">{count}</span>
						</a>
					</li>
				)})}
			</ul>

			<div class="total-info">
				共 {shuffledTags.length} 个分类，{posts.length} 篇文章
			</div>
		</main>
		<Footer />
	</body>
</html>