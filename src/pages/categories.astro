---
import { getCollection } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_TITLE } from '../consts';

const posts = await getCollection('blog');

// 统计每个标签的文章数量
const tagCounts = new Map<string, number>();
posts.forEach(post => {
	post.data.tags.forEach(tag => {
		tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
	});
});

// 转换为数组
const tags = Array.from(tagCounts.entries());
// 计算最大和最小文章数（用于客户端计算字体大小）
const counts = tags.map(([_, count]) => count);
const maxCount = Math.max(...counts);
const minCount = Math.min(...counts);
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead title={`分类 - ${SITE_TITLE}`} description="博客文章分类" />
		<link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&family=Noto+Serif+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
		<style>
			/* 标签云容器 */
			.tag-cloud-container {
				display: flex;
				flex-wrap: wrap;
				justify-content: center;
				align-items: center;
				list-style: none;
				margin: 0;
				padding: 10rem 2rem 5rem; 
				overflow: visible;
				position: relative;
				max-width: 800px;
				margin-left: auto;
				margin-right: auto;
			}

			.category-item {
				position: relative;
				transition: z-index 0s; 
			}

			.category-item:hover {
				z-index: 9999 !important;
			}

			.category-link {
				display: inline-flex;
				align-items: center;
				gap: 0.3em;
				padding: 0.4em 0.8em;
				background-color: var(--box-bg);
				text-decoration: none;
				color: var(--main-color);
				border: 1px solid transparent;
				cursor: pointer;
				
				/* === 初始化 CSS 变量 === */
				--tx: 0px;
				--ty: 0px;
				--rot: 0deg;
				--hover-rot: 0deg; /* 悬停时的额外旋转角度 */

				/* === 核心：使用变量组合 transform === */
				transform: translate(var(--tx), var(--ty)) rotate(var(--rot));
				
				transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
				will-change: transform;
				backface-visibility: hidden;
			}

			.category-link:hover {
				border-color: var(--main-color);
				background-color: var(--bg-color);
				/* 悬停时：保持原位移，原角度 + 悬停角度，并放大 */
				transform: translate(var(--tx), var(--ty)) rotate(calc(var(--rot) + var(--hover-rot))) scale(1.2);
				box-shadow: 4px 4px 0px 0px var(--main-color);
			}

			.category-name {
				font-weight: 500;
				line-height: 1;
			}

			.category-count {
				font-size: 0.75em;
				font-weight: bold;
				opacity: 0.6;
				margin-left: 2px;
				vertical-align: top;
			}

			.total-info {
				margin-top: 5rem;
				text-align: center;
				color: var(--main-color);
				font-size: 0.75rem; 
				opacity: 0.6;
			}

			@media (max-width: 768px) {
				.tag-cloud-container {
					padding: 6rem 1rem;
				}
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<ul class="tag-cloud-container" id="tag-cloud">
				{tags.map(([tag, count]) => (
					<li 
						class="category-item" 
						data-count={count}
						data-max={maxCount}
						data-min={minCount}
					>
						<a 
							href={`/tags/${tag}/`} 
							class="category-link"
						>
							<span class="category-name"># {tag}</span>
							<span class="category-count">{count}</span>
						</a>
					</li>
				))}
			</ul>

			<div class="total-info">
				共 {tags.length} 个分类，{posts.length} 篇文章
			</div>
		</main>
		<Footer />

		<script>
			function initTagCloud() {
				const container = document.getElementById('tag-cloud');
				if (!container) return;

				const items = Array.from(container.querySelectorAll('.category-item'));
				
				// 1. 随机打乱顺序
				items.sort(() => Math.random() - 0.5);
				items.forEach(item => container.appendChild(item));

				// 2. 为每个标签应用随机样式
				items.forEach((item) => {
					const count = parseInt(item.getAttribute('data-count') || '0');
					const maxCount = parseInt(item.getAttribute('data-max') || '1');
					const minCount = parseInt(item.getAttribute('data-min') || '0');
					const link = item.querySelector('.category-link');
					
					if (!link) return;

					// 计算字体大小
					const range = maxCount - minCount;
					const percent = range === 0 ? 0.5 : (count - minCount) / range;
					const fontSize = 1 + percent * 2;

					// 生成随机角度 (-45 ~ 45 度)
					const rot = Math.floor(Math.random() * 90) - 45;

					// 生成随机位移 (X, Y)
					const tx = Math.floor(Math.random() * 40) - 20;
					const ty = Math.floor(Math.random() * 40) - 20;

					// 生成随机外边距
					const marginX = (Math.random() * 2 - 1).toFixed(2);
					const marginY = (Math.random() * 1 - 0.5).toFixed(2);

					// 生成随机层级 (0-10)
					const zIndex = Math.floor(Math.random() * 10);

					// === 应用样式 ===
					link.style.fontSize = `${fontSize.toFixed(2)}rem`;
					
					// 核心修改：将随机值存入 CSS 变量，而不是直接写死 transform
					link.style.setProperty('--tx', `${tx}px`);
					link.style.setProperty('--ty', `${ty}px`);
					link.style.setProperty('--rot', `${rot}deg`);
					
					item.style.margin = `${marginY}rem ${marginX}rem`;
					item.style.zIndex = zIndex.toString();

					// 3. 添加鼠标事件：每次悬停时重新生成随机旋转增量
					link.addEventListener('mouseenter', () => {
						// 这里生成一个 -20 到 20 度的额外旋转
						const hoverRot = Math.floor(Math.random() * 40) - 20;
						link.style.setProperty('--hover-rot', hoverRot + 'deg');
					});
				});
			}

			// 页面加载时初始化
			document.addEventListener('astro:page-load', initTagCloud);
		</script>
	</body>
</html>