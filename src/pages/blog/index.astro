---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);
const postsByYear = posts.reduce((acc, post) => {
    const year = post.data.pubDate.getFullYear();
    if (!acc[year]) {
        acc[year] = [];
    }
    acc[year].push(post);
    return acc;
}, {});
const years = Object.keys(postsByYear).sort((a, b) => b - a);
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
        <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&display=swap" rel="stylesheet">
		<style>
            main {
                display: block;
                width: 100%;
                max-width: 672px;
                margin: 0 auto;
                padding: 0 1rem;
            }

            .blog-container-wrapper {
                position: relative;
                width: 100%;
                height: 80vh; 
                margin: 0 0 2rem 0; 
            }

            #content-scroll-area {
                width: 100%;
                height: 100%;
                overflow-y: auto; 
                scrollbar-width: none; 
                -ms-overflow-style: none; 
                padding-right: 10px; 
                scroll-behavior: smooth;
            }
            
            #content-scroll-area::-webkit-scrollbar {
                display: none; 
            }

			.year-section {
				margin-bottom: 2rem;
			}
			.year-section:last-of-type {
				margin-bottom: 3rem; 
			}
			
			ul {
				list-style-type: none;
				padding: 0;
                margin: 0;
			}

			.post-item {
				margin-bottom: 1rem;
				display: block;
			}

            /* 前5个文章参与 View Transition */
            .post-item[data-index="0"],
            .post-item[data-index="1"],
            .post-item[data-index="2"],
            .post-item[data-index="3"],
            .post-item[data-index="4"] {
                /* View Transition 会自动处理这些 */
            }

            /* 第6个及之后:直接显示,不要动画 */
            .post-item[data-animate="true"] {
                /* 移除所有动画相关样式 */
            }

			.post-link {
				text-decoration: none;
				display: block;
                position: relative; 
			}

			.title-wrapper {
				position: relative;
				display: inline-block;
				padding-right: 1.25rem;
				cursor: pointer;
			}

			.title-bg {
				position: absolute;
				left: 0;
				top: 0;
				height: 100%;
				width: 4px;
				background-color: var(--main-color);
				z-index: -1;
				transition: width 0.3s ease-in-out;
			}

			.post-item:hover .title-bg {
				width: 100%;
			}

            .post-title {
                font-family: 'MyLocalZhongSong', 'STZhongsong', '华文中宋', 'SimSun', serif;
                font-size: 1.5rem; 
                font-weight: bold;
                color: var(--main-color);
                padding-left: 1rem;
                transition: color 0.3s ease;
                margin: 0;
                position: relative;
                z-index: 10;
            }

            /* [修改] 这里改用 var(--bg-color) */
            /* 这样在暗黑模式下，背景是黑的，文字就会变黑，从而在白色的竖条上显示出来 */
            .post-item:hover .post-title {
                color: var(--bg-color); 
            }

            .post-year {
                position: absolute;
                right: 0; 
                top: 50%;
                transform: translateY(-50%); 
                font-family: 'Alfa Slab One', cursive; 
                font-size: 1.5rem; 
                white-space: nowrap;
                color: var(--main-color); 
                opacity: 0; 
                pointer-events: none;
                transition: opacity 0.3s ease;
                z-index: 1; 
            }

            .post-link:hover .post-year {
                opacity: 1; 
            }

            @media (max-width: 600px) {
                .post-year {
                    display: none; 
                }
            }
		</style>
	</head>
	<body>
		<Header />
		<main>
            <div class="blog-container-wrapper">
                <div id="content-scroll-area">
                    {years.map(year => {
                        return (
                            <section class="year-section">
                                <ul>
                                    {postsByYear[year].map((post) => {
                                        const dateStr = post.data.pubDate.toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'long'
                                        });
                                        
                                        const globalIndex = posts.findIndex(p => p.id === post.id);
                                        const needsAnimation = globalIndex >= 5;
                                        const animateIndex = needsAnimation ? (globalIndex - 5) : 0;

                                        return (
                                            <li 
                                                class="post-item"
                                                data-index={globalIndex}
                                                data-animate={needsAnimation ? "true" : "false"}
                                                data-animate-index={animateIndex}
                                            >
                                                <a href={`/blog/${post.id}/`} class="post-link">
                                                    <div 
                                                        class="title-wrapper" 
                                                        transition:name={!needsAnimation ? `title-${post.id}` : undefined}
                                                    >
                                                        <div class="title-bg"></div>
                                                        <h3 class="post-title">
                                                            {post.data.title}
                                                        </h3>
                                                    </div>
                                                    
                                                    <span class="post-year">{dateStr}</span>
                                                </a>
                                            </li>
                                        );
                                    })}
                                </ul>
                            </section>
                        );
                    })}
                </div>
            </div>
		</main>
		<Footer />

        <script>
            // 移除所有动画相关代码,保持页面简洁
            // 只有前5个标题会通过 View Transition 产生动画效果
        </script>
	</body>
</html>