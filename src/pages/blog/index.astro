---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';

// ==========================================
// 1. 数据处理逻辑
// ==========================================

// 获取所有文章并按时间倒序排序
const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// 2. 分组逻辑
const groupsMap = new Map();

for (const post of sortedPosts) {
    const year = post.data.pubDate.getFullYear();
    const monthStr = post.data.pubDate.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();
    
    if (!groupsMap.has(year)) {
        groupsMap.set(year, []);
    }
    
    const postsInYear = groupsMap.get(year);
    const lastPost = postsInYear.length > 0 ? postsInYear[postsInYear.length - 1] : null;
    
    // 判断是否显示月份
    const showMonth = !lastPost || lastPost.monthStr !== monthStr;
    
    postsInYear.push({
        originalPost: post,
        monthStr: monthStr,
        showMonth: showMonth
    });
}

// 3. 转换为数组并按年份倒序
const yearGroups = Array.from(groupsMap.entries())
    .sort((a, b) => b[0] - a[0])
    .map(([year, posts]) => ({ year, posts }));
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead title={`归档 - ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
        <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&display=swap" rel="stylesheet">
		<style>
            /* 页面整体布局 */
            main {
                width: 100%;
                max-width: 672px;
                margin: 0 auto;
                padding: 2rem 1rem;
            }

            /* --- 年份区块容器 --- */
            .year-group {
                position: relative;
                margin-bottom: 5rem;
                isolation: isolate; 
            }

            /* --- 年份数字 --- */
            .year-label {
                font-family: 'Alfa Slab One', cursive;
                /* [修改] 再次调小字号 */
                font-size: 4rem; 
                line-height: 1;
                color: var(--main-color);
                
                position: absolute;
                /* [修改] 配合小字号微调位置 */
                top: -1.8rem; 
                right: 1.5rem;  
                
                z-index: 0;   
                /* [修改] 移除透明度，保持不透明 */
                opacity: 1; 
                pointer-events: none;
            }

            /* --- 文章列表底框 --- */
            .articles-box {
                position: relative;
                z-index: 10; 
                background-color: var(--box-bg); 
                padding: 2.5rem 2rem;
            }

            /* --- 文章列表 --- */
            .post-list {
                list-style: none;
                padding: 0;
                margin: 0;
                display: flex;
                flex-direction: column;
                gap: 1.25rem;
            }

            .post-row {
                display: flex;
                align-items: baseline;
                gap: 1.5rem;
                text-decoration: none;
            }
            
            /* --- 月份 --- */
            .post-month {
                font-family: 'Alfa Slab One', cursive;
                font-size: 1.25rem;
                color: var(--main-color);
                width: 3.5rem; 
                text-align: right; 
                flex-shrink: 0;
            }

            /* --- 标题容器 (用于悬停动画) --- */
            .title-wrapper {
                position: relative;
                display: inline-block;
                padding: 0 0.5rem;
                margin: 0 -0.5rem; 
                transition: color 0.3s ease;
            }

            /* --- 标题背景 (悬停变长) --- */
            .title-bg {
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                width: 0;
                background-color: var(--main-color);
                z-index: -1;
                transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            }

            /* --- 标题文字 --- */
            .post-title-text {
                font-family: 'MyLocalZhongSong', 'STZhongsong', '华文中宋', serif;
                font-size: 1.1rem;
                color: var(--main-color);
                font-weight: normal;
                line-height: 1.6;
                position: relative;
                z-index: 1;
                transition: color 0.3s ease;
            }

            /* ====== 悬停交互 ====== */
            
            /* 1. 背景展开 */
            .post-row:hover .title-bg {
                width: 100%;
            }

            /* 2. 文字变色 */
            .post-row:hover .post-title-text {
                color: var(--bg-color); 
            }

            /* ====== 镜像模式 (偶数项) ====== */
            .year-group.mirror .year-label {
                right: auto;
                left: 1.5rem; 
            }

            .year-group.mirror .post-row {
                flex-direction: row-reverse; 
            }
            
            .year-group.mirror .post-month {
                text-align: left; 
            }
            
            .year-group.mirror .post-title-text {
                text-align: right; 
            }

            /* 移动端适配 */
            @media (max-width: 600px) {
                .year-label {
                    font-size: 3rem; /* 移动端对应缩小 */
                    top: -1.2rem;
                }
                .articles-box {
                    padding: 1.5rem 1rem;
                }
                /* 移动端取消镜像 */
                .year-group.mirror .year-label {
                    right: 1rem;
                    left: auto;
                }
                .year-group.mirror .post-row {
                    flex-direction: row;
                }
                .year-group.mirror .post-month {
                    text-align: right;
                }
                .year-group.mirror .post-title-text {
                    text-align: left;
                }
            }
		</style>
	</head>
	<body>
		<Header />
		<main>
            {yearGroups.map((group, index) => {
                const isMirror = index % 2 !== 0;

                return (
                    <div class={`year-group ${isMirror ? 'mirror' : ''}`}>
                        <div class="year-label">{group.year}</div>

                        <div class="articles-box">
                            <ul class="post-list">
                                {group.posts.map((item) => (
                                    <li>
                                        <a href={`/blog/${item.originalPost.id}/`} class="post-row">
                                            {/* 月份 */}
                                            <span class="post-month">
                                                {item.showMonth ? item.monthStr : ''}
                                            </span>
                                            
                                            {/* 标题部分 */}
                                            <div class="title-wrapper">
                                                <div class="title-bg"></div>
                                                <span class="post-title-text">
                                                    {item.originalPost.data.title}
                                                </span>
                                            </div>
                                        </a>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    </div>
                );
            })}
		</main>
		<Footer />
	</body>
</html>